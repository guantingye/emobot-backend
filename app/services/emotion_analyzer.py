# backend/app/services/emotion_analyzer.py - å°ˆæ¥­ç‰ˆ
from typing import Dict, List, Any, Tuple
from datetime import datetime, timedelta
from collections import Counter, defaultdict
import re
import math

# ============================================================================
# å°ˆæ¥­ç´šæƒ…ç·’è©åº« (åŸºæ–¼å¿ƒç†å­¸åˆ†é¡)
# ============================================================================

EMOTION_KEYWORDS = {
    "ç„¦æ…®ä¸å®‰": {
        "keywords": ["æ“”å¿ƒ", "å®³æ€•", "ç·Šå¼µ", "ç„¦æ…®", "ä¸å®‰", "ææ‡¼", "é©šæ…Œ", "ç…©èº", "å¿å¿‘", "æƒ¶æ"],
        "weight": 1.2,  # è² é¢æƒ…ç·’æ¬Šé‡è¼ƒé«˜
        "color": "#FF6B6B"
    },
    "æ†‚é¬±ä½è½": {
        "keywords": ["é›£é", "æ†‚é¬±", "ä½è½", "æ²®å–ª", "å¤±è½", "æ‚²å‚·", "ç—›è‹¦", "çµ•æœ›", "å­¤å–®", "ç©ºè™›"],
        "weight": 1.2,
        "color": "#4ECDC4"
    },
    "æ†¤æ€’ç…©èº": {
        "keywords": ["ç”Ÿæ°£", "æ†¤æ€’", "ç«å¤§", "ä¸çˆ½", "ç…©", "è¨å­", "æ°£", "æ¨", "æŠ“ç‹‚"],
        "weight": 1.1,
        "color": "#FF8C42"
    },
    "å£“åŠ›ç–²æ†Š": {
        "keywords": ["å£“åŠ›", "ç´¯", "ç–²æ†Š", "å¿™", "è¶•", "çˆ†ç‚¸", "å—ä¸äº†", "æ’ä¸ä½", "å´©æ½°"],
        "weight": 1.15,
        "color": "#95E1D3"
    },
    "å¿«æ¨‚æ»¿è¶³": {
        "keywords": ["é–‹å¿ƒ", "å¿«æ¨‚", "é«˜èˆˆ", "å–œæ­¡", "æ£’", "å¥½", "è®š", "çˆ½", "èˆˆå¥®", "æ»¿è¶³"],
        "weight": 0.9,
        "color": "#FEE440"
    },
    "å¹³éœæ”¾é¬†": {
        "keywords": ["å¹³éœ", "æ”¾é¬†", "èˆ’æœ", "å®‰å¿ƒ", "ç©©å®š", "é‚„å¥½", "æ²’äº‹", "æ·¡å®š", "å¾å®¹"],
        "weight": 0.8,
        "color": "#38B6FF"
    },
    "å›°æƒ‘è¿·èŒ«": {
        "keywords": ["å›°æƒ‘", "è¿·èŒ«", "ä¸çŸ¥é“", "çŒ¶è±«", "ç³¾çµ", "çŸ›ç›¾", "ç–‘æƒ‘", "è¿·å¤±"],
        "weight": 1.0,
        "color": "#B983FF"
    }
}

TOPIC_KEYWORDS = {
    "äººéš›é—œä¿‚": {
        "keywords": ["æœ‹å‹", "å®¶äºº", "åŒäº‹", "é—œä¿‚", "ç›¸è™•", "åµæ¶", "æºé€š", "å­¤å–®", "ç¤¾äº¤", "äººéš›"],
        "weight": 1.0,
        "color": "#FF6B9D"
    },
    "å·¥ä½œè·å ´": {
        "keywords": ["å·¥ä½œ", "ä¸Šç­", "è€é—†", "åŒäº‹", "åŠ ç­", "å°ˆæ¡ˆ", "æ¥­ç¸¾", "å ±å‘Š", "è·å ´", "å·¥ä½œ"],
        "weight": 1.1,
        "color": "#5B8DEE"
    },
    "å­¸æ¥­æˆé•·": {
        "keywords": ["è€ƒè©¦", "æˆç¸¾", "å­¸æ ¡", "è€å¸«", "ä½œæ¥­", "å ±å‘Š", "è®€æ›¸", "èª²æ¥­", "å­¸ç¿’", "é€²ä¿®"],
        "weight": 1.0,
        "color": "#00D9FF"
    },
    "æƒ…æ„Ÿæ„›æƒ…": {
        "keywords": ["æ„Ÿæƒ…", "æˆ€æ„›", "åˆ†æ‰‹", "å–œæ­¡", "æ›–æ˜§", "å‘Šç™½", "å¤±æˆ€", "äº¤å¾€", "ä¼´ä¾¶", "å–œæ­¡"],
        "weight": 1.2,
        "color": "#FF85A2"
    },
    "è‡ªæˆ‘èªåŒ": {
        "keywords": ["è‡ªå·±", "è‡ªæˆ‘", "åƒ¹å€¼", "æ„ç¾©", "è¿·æƒ˜", "ç‚ºä»€éº¼", "èº«åˆ†", "äººç”Ÿ", "æœªä¾†", "ç›®æ¨™"],
        "weight": 1.15,
        "color": "#A8E6CF"
    },
    "èº«å¿ƒå¥åº·": {
        "keywords": ["èº«é«”", "å¥åº·", "ç”Ÿç—…", "ç—›", "ä¸èˆ’æœ", "ç¡ä¸è‘—", "å¤±çœ ", "é ­ç—›", "ç–²å‹", "ç„¦æ…®"],
        "weight": 1.2,
        "color": "#FFB6B9"
    }
}

# å¼·åº¦ä¿®é£¾è©ï¼ˆæ›´ç²¾ç´°åŒ–ï¼‰
INTENSITY_MODIFIERS = {
    "æ¥µå¼·": {
        "words": ["éå¸¸éå¸¸", "è¶…ç´šè¶…ç´š", "æ¥µåº¦", "å®Œå…¨", "çµ•å°"],
        "multiplier": 1.5
    },
    "å¼·": {
        "words": ["éå¸¸", "è¶…ç´š", "çœŸçš„å¾ˆ", "å¤ª", "ç‰¹åˆ¥", "ç›¸ç•¶"],
        "multiplier": 1.3
    },
    "ä¸­å¼·": {
        "words": ["å¾ˆ", "è »", "æŒº", "ååˆ†", "é —"],
        "multiplier": 1.1
    },
    "ä¸­": {
        "words": ["æœ‰é»", "é‚„ç®—", "ç¨å¾®", "äº›è¨±", "ç®—æ˜¯"],
        "multiplier": 0.9
    },
    "å¼±": {
        "words": ["ä¸€é»é»", "ä¸å¤ª", "å¾®å¾®", "ä¼¼ä¹", "å¥½åƒ"],
        "multiplier": 0.7
    }
}

# æ™‚é–“è¡°æ¸›ä¿‚æ•¸ï¼ˆè¿‘æœŸè¨Šæ¯æ¬Šé‡æ›´é«˜ï¼‰
def time_decay_weight(days_ago: int) -> float:
    """è¨ˆç®—æ™‚é–“è¡°æ¸›æ¬Šé‡ï¼Œè¶Šè¿‘æœŸçš„è¨Šæ¯æ¬Šé‡è¶Šé«˜"""
    return math.exp(-0.05 * days_ago)

# ============================================================================
# æ ¸å¿ƒåˆ†æå‡½æ•¸
# ============================================================================

def calculate_emotion_intensity(text: str, base_score: float) -> float:
    """
    è¨ˆç®—æƒ…ç·’å¼·åº¦ï¼ˆè€ƒæ…®ä¿®é£¾è©ã€æ¨™é»ç¬¦è™Ÿç­‰ï¼‰
    
    Args:
        text: è¨Šæ¯æ–‡æœ¬
        base_score: åŸºç¤åˆ†æ•¸
    
    Returns:
        èª¿æ•´å¾Œçš„å¼·åº¦åˆ†æ•¸ (0.0 - 1.0)
    """
    intensity = base_score
    
    # æª¢æŸ¥å¼·åº¦ä¿®é£¾è©
    for level_data in INTENSITY_MODIFIERS.values():
        for word in level_data["words"]:
            if word in text:
                intensity *= level_data["multiplier"]
                break
    
    # æ¨™é»ç¬¦è™ŸåŠ æˆ
    exclamation_count = text.count("ï¼") + text.count("!")
    question_count = text.count("ï¼Ÿï¼Ÿ") + text.count("??")
    
    intensity *= (1 + exclamation_count * 0.1)
    intensity *= (1 + question_count * 0.08)
    
    # å…¨å¤§å¯«åŠ æˆï¼ˆè‹¥æœ‰è‹±æ–‡ï¼‰
    if re.search(r'[A-Z]{3,}', text):
        intensity *= 1.15
    
    return min(intensity, 1.0)

def detect_emotions_advanced(text: str, days_ago: int = 0) -> Dict[str, float]:
    """
    é€²éšæƒ…ç·’åµæ¸¬ï¼ˆè€ƒæ…®æ¬Šé‡ã€æ™‚é–“è¡°æ¸›ï¼‰
    
    Returns:
        {æƒ…ç·’åç¨±: åŠ æ¬Šåˆ†æ•¸}
    """
    emotions = {}
    
    for emotion, data in EMOTION_KEYWORDS.items():
        keywords = data["keywords"]
        weight = data["weight"]
        
        # è¨ˆç®—é—œéµè©å‡ºç¾æ¬¡æ•¸
        count = sum(text.count(word) for word in keywords)
        
        if count > 0:
            # åŸºç¤åˆ†æ•¸
            base_score = min(count * 0.15, 0.8)
            
            # è€ƒæ…®å¼·åº¦ä¿®é£¾è©
            intensity = calculate_emotion_intensity(text, base_score)
            
            # æ‡‰ç”¨æƒ…ç·’æ¬Šé‡
            weighted_score = intensity * weight
            
            # æ‡‰ç”¨æ™‚é–“è¡°æ¸›
            time_weighted = weighted_score * time_decay_weight(days_ago)
            
            emotions[emotion] = time_weighted
    
    return emotions

def detect_topics_advanced(text: str) -> Dict[str, float]:
    """é€²éšè­°é¡Œåµæ¸¬"""
    topics = {}
    
    for topic, data in TOPIC_KEYWORDS.items():
        keywords = data["keywords"]
        weight = data["weight"]
        
        count = sum(text.count(word) for word in keywords)
        
        if count > 0:
            score = min(count * 0.2, 0.9) * weight
            topics[topic] = score
    
    return topics

def analyze_emotion_trends(timeline_data: List[Dict]) -> Dict[str, Any]:
    """
    åˆ†ææƒ…ç·’è¶¨å‹¢è®ŠåŒ–
    
    Returns:
        åŒ…å«è¶¨å‹¢è³‡è¨Šçš„å­—å…¸
    """
    if len(timeline_data) < 5:
        return {"trend": "insufficient_data"}
    
    # å–æœ€è¿‘çš„æƒ…ç·’åˆ†æ•¸
    recent_emotions = [d["dominant_emotion"] for d in timeline_data[-10:]]
    emotion_counter = Counter(recent_emotions)
    
    # åˆ¤æ–·è¶¨å‹¢
    negative_emotions = ["ç„¦æ…®ä¸å®‰", "æ†‚é¬±ä½è½", "æ†¤æ€’ç…©èº", "å£“åŠ›ç–²æ†Š"]
    negative_count = sum(1 for e in recent_emotions if e in negative_emotions)
    
    if negative_count > len(recent_emotions) * 0.7:
        trend = "concerning"
        trend_description = "è¿‘æœŸè² é¢æƒ…ç·’è¼ƒå¤šï¼Œå»ºè­°å°‹æ±‚æ”¯æŒ"
    elif negative_count > len(recent_emotions) * 0.4:
        trend = "fluctuating"
        trend_description = "æƒ…ç·’èµ·ä¼è¼ƒå¤§ï¼Œæ³¨æ„è‡ªæˆ‘èª¿é©"
    else:
        trend = "stable"
        trend_description = "æƒ…ç·’ç‹€æ…‹ç›¸å°ç©©å®š"
    
    return {
        "trend": trend,
        "description": trend_description,
        "dominant_emotions": dict(emotion_counter.most_common(3))
    }

def generate_professional_summary(
    emotion_freq: Dict[str, int],
    emotion_intensity: Dict[str, float],
    topics: Dict[str, float],
    message_count: int,
    trend_info: Dict[str, Any]
) -> str:
    """
    ç”Ÿæˆå°ˆæ¥­çš„å¿ƒç†åˆ†ææ‘˜è¦ - æ·±åº¦ç‰ˆ
    
    çµåˆå¿ƒç†å­¸ç†è«–èˆ‡äººæ€§åŒ–é—œæ‡·
    """
    
    if message_count < 30:
        return f"ç›®å‰å°è©±æ¬¡æ•¸ç‚º {message_count} æ¬¡,å»ºè­°ç´¯ç©è‡³å°‘ 30 æ¬¡å°è©±å¾Œå†é€²è¡Œå®Œæ•´åˆ†æ,ä»¥ç²å¾—æ›´æº–ç¢ºçš„å¿ƒç†ç‹€æ…‹è©•ä¼°ã€‚"
    
    summary_parts = []
    
    # é–‹å ´ç™½ - æº«æš–çš„å•å€™
    summary_parts.append("ğŸ“– **ä½ çš„å¿ƒæƒ…æ•…äº‹**")
    summary_parts.append(f"åœ¨éå»çš„ **{message_count} æ¬¡å°è©±**ä¸­,ä½ èˆ‡æˆ‘åˆ†äº«äº†å…§å¿ƒçš„èµ·ä¼èˆ‡æ€è€ƒã€‚æ¯ä¸€æ¬¡çš„è¡¨é”éƒ½æ˜¯å‹‡æ•¢çš„è‡ªæˆ‘æ­éœ²,è®“æˆ‘å€‘ä¸€èµ·ä¾†çœ‹çœ‹é€™æ®µæ™‚é–“ä½ çš„å¿ƒç†è»Œè·¡ã€‚")
    
    # ä¸»è¦æƒ…ç·’åˆ†æ - æ·±åº¦è§£è®€
    if emotion_freq:
        top_emotion = max(emotion_freq.items(), key=lambda x: x[1])[0]
        freq_count = emotion_freq[top_emotion]
        total_count = sum(emotion_freq.values())
        emotion_percentage = round((freq_count / total_count) * 100, 1)
        
        summary_parts.append(f"\nğŸ“Š **æƒ…ç·’æ ¸å¿ƒæ¨£è²Œ**")
        summary_parts.append(f"ä½ æœ€å¸¸è¡¨é”çš„æ˜¯ã€Œ**{top_emotion}**ã€,åœ¨å°è©±ä¸­å‡ºç¾äº† **{freq_count} æ¬¡**,ä½”æ‰€æœ‰æƒ…ç·’è¡¨é”çš„ **{emotion_percentage}%**ã€‚é€™ä¸åªæ˜¯æ•¸å­—,å®ƒåæ˜ äº†ä½ æœ€è¿‘ç”Ÿæ´»ä¸­çš„**ä¸»è¦æƒ…ç·’åŸºèª¿**ã€‚")
        
        # æƒ…ç·’å¼·åº¦çš„æ·±åº¦åˆ†æ
        if emotion_intensity and top_emotion in emotion_intensity:
            intensity_value = emotion_intensity[top_emotion]
            
            if intensity_value > 75:
                summary_parts.append(f"\nç•¶ä½ æ„Ÿå—åˆ°é€™ç¨®æƒ…ç·’æ™‚,**å¼·åº¦æŒ‡æ•¸é”åˆ° {round(intensity_value, 1)}/100**ã€‚é€™æ˜¯ç›¸ç•¶é«˜çš„å¼·åº¦,æ„å‘³è‘—é€™äº›æƒ…ç·’æ·±æ·±åœ°å½±éŸ¿è‘—ä½ ã€‚ä½ å¯èƒ½æœƒæ„Ÿè¦ºè¢«æƒ…ç·’æ·¹æ²’,é›£ä»¥æŠ½é›¢ã€‚é€™æ¨£çš„æ„Ÿå—æ˜¯**çœŸå¯¦ä¸”é‡è¦çš„**,ä¸éœ€è¦å¦èªæˆ–å£“æŠ‘ã€‚")
            elif intensity_value > 50:
                summary_parts.append(f"\nç•¶ä½ æ„Ÿå—åˆ°é€™ç¨®æƒ…ç·’æ™‚,**å¼·åº¦æŒ‡æ•¸é”åˆ° {round(intensity_value, 1)}/100**ã€‚é€™æ˜¯æ˜é¡¯ä¸”æ¸…æ™°çš„æƒ…ç·’é«”é©—ã€‚ä½ èƒ½æ¸…æ¥šæ„Ÿå—åˆ°å®ƒçš„å­˜åœ¨,ä½†é‚„ä¸è‡³æ–¼å¤±æ§ã€‚é€™å€‹å¼·åº¦é¡¯ç¤ºä½ **æ—¢èƒ½æ„Ÿå—æƒ…ç·’,ä¹Ÿé‚„ä¿æœ‰ä¸€å®šçš„è§€å¯Ÿè·é›¢**ã€‚")
            elif intensity_value > 30:
                summary_parts.append(f"\nç•¶ä½ æ„Ÿå—åˆ°é€™ç¨®æƒ…ç·’æ™‚,**å¼·åº¦æŒ‡æ•¸é”åˆ° {round(intensity_value, 1)}/100**ã€‚é€™æ˜¯æº«å’Œè€ŒæŒçºŒçš„æƒ…ç·’ç‹€æ…‹ã€‚å®ƒåƒèƒŒæ™¯éŸ³æ¨‚ä¸€æ¨£å­˜åœ¨,ä¸æœƒå¤ªéå¼·çƒˆ,ä½†ç¢ºå¯¦å½±éŸ¿è‘—ä½ çš„**æ—¥å¸¸æ„Ÿå—èˆ‡æ±ºç­–**ã€‚")
            else:
                summary_parts.append(f"\nç•¶ä½ æ„Ÿå—åˆ°é€™ç¨®æƒ…ç·’æ™‚,**å¼·åº¦æŒ‡æ•¸é”åˆ° {round(intensity_value, 1)}/100**ã€‚é€™æ˜¯è¼ƒç‚ºæŸ”å’Œçš„æƒ…ç·’é«”é©—ã€‚ä½ å±•ç¾å‡º**è‰¯å¥½çš„æƒ…ç·’èª¿ç¯€èƒ½åŠ›**,èƒ½åœ¨æ„Ÿå—æƒ…ç·’çš„åŒæ™‚ä¿æŒå…§åœ¨å¹³è¡¡ã€‚")
        
        # æ ¹æ“šä¸»è¦æƒ…ç·’çµ¦äºˆæ·±åº¦ä¸”æº«æš–çš„å»ºè­°
        if top_emotion == "ç„¦æ…®ä¸å®‰":
            summary_parts.append("\nğŸ’¡ **å¯«çµ¦ç„¦æ…®çš„ä½ **")
            summary_parts.append("ç„¦æ…®å°±åƒå¿ƒè£¡ä½è‘—ä¸€ä½**éåº¦ç›¡è²¬çš„å®ˆè¡›**,ç¸½æƒ³æå‰é é˜²æ‰€æœ‰å¯èƒ½çš„å±éšªã€‚å®ƒçš„å‡ºç™¼é»æ˜¯ä¿è­·ä½ ,ä½†æœ‰æ™‚æœƒéåº¦è­¦æˆ’ã€‚")
            summary_parts.append("\nå¾å¿ƒç†å­¸è§’åº¦ä¾†çœ‹,ç„¦æ…®å¾€å¾€æºæ–¼:**å°æœªä¾†çš„ä¸ç¢ºå®šæ„Ÿã€å°å¤±æ§çš„ææ‡¼ã€ä»¥åŠå®Œç¾ä¸»ç¾©çš„å£“åŠ›**ã€‚è®“æˆ‘å€‘ä¸€èµ·ç†è§£å®ƒ,è€Œéå°æŠ—å®ƒã€‚")
            summary_parts.append("\n**ç«‹å³å¯ç”¨çš„æŠ€å·§:**")
            summary_parts.append("â€¢ **5-4-3-2-1 æ¥åœ°æ³•**: ç•¶ç„¦æ…®ä¾†è¥²,èªªå‡ºä½ çœ‹è¦‹çš„5æ¨£æ±è¥¿ã€è½åˆ°çš„4ç¨®è²éŸ³ã€è§¸æ‘¸çš„3æ¨£ç‰©å“ã€èåˆ°çš„2ç¨®æ°£å‘³ã€åšåˆ°çš„1ç¨®å‘³é“ã€‚é€™èƒ½å°‡ä½ çš„**æ„è­˜å¾æœªä¾†æ‹‰å›ç•¶ä¸‹**ã€‚")
            summary_parts.append("â€¢ **ç„¦æ…®å°è©±ç·´ç¿’**: æŠŠç„¦æ…®æƒ³åƒæˆä¸€å€‹äºº,å•å®ƒ:ã€Œä½ åœ¨æ“”å¿ƒä»€éº¼?ã€ã€Œä½ æƒ³ä¿è­·æˆ‘å…æ–¼ä»€éº¼?ã€ã€Œé€™å€‹æ“”å¿ƒæœ‰å¤šå°‘æ˜¯çœŸå¯¦çš„?ã€é€é**å°è©±è€Œéå°æŠ—**,ä½ æœƒç™¼ç¾ç„¦æ…®èƒŒå¾Œçš„çœŸå¯¦éœ€æ±‚ã€‚")
            summary_parts.append("â€¢ **æ§åˆ¶åœˆèˆ‡å½±éŸ¿åœˆ**: å°‡æ“”å¿ƒçš„äº‹æƒ…åˆ†é¡:å“ªäº›æ˜¯ä½ **èƒ½æ§åˆ¶çš„**(å¦‚æº–å‚™ç¨‹åº¦ã€æ‡‰å°æ–¹å¼)?å“ªäº›æ˜¯**å®Œå…¨ç„¡æ³•æ§åˆ¶çš„**(å¦‚ä»–äººæƒ³æ³•ã€çµæœ)?æŠŠèƒ½é‡æ”¾åœ¨æ§åˆ¶åœˆå…§,æ¥å—å½±éŸ¿åœˆçš„ä¸ç¢ºå®šã€‚")
            summary_parts.append("\n**é•·æœŸå»ºè­°**: è€ƒæ…®å­¸ç¿’**èªçŸ¥è¡Œç‚ºæ²»ç™‚(CBT)**æŠ€å·§,å®ƒèƒ½å¹«åŠ©ä½ è¾¨è­˜èˆ‡æ”¹è®Šç„¦æ…®çš„æ€è€ƒæ¨¡å¼ã€‚å¦‚æœç„¦æ…®æŒçºŒå½±éŸ¿ç¡çœ ã€å·¥ä½œæˆ–äººéš›é—œä¿‚,å°‹æ±‚å°ˆæ¥­å¿ƒç†å¸«çš„å”åŠ©æ˜¯**æ™ºæ…§è€Œéè»Ÿå¼±**çš„é¸æ“‡ã€‚")
            
        elif top_emotion == "æ†‚é¬±ä½è½":
            summary_parts.append("\nğŸ’¡ **å¯«çµ¦ä½è½çš„ä½ **")
            summary_parts.append("æ†‚é¬±åƒæ˜¯**å¿ƒéˆçš„é‡æ„Ÿå†’**,å®ƒæœƒè®“ä¸€åˆ‡éƒ½è®Šå¾—ç°æš—ã€æ²‰é‡,é€£å¹³å¸¸å–œæ­¡çš„äº‹éƒ½å¤±å»äº†è‰²å½©ã€‚å¦‚æœä½ æ­£ç¶“æ­·é€™æ¨£çš„æ„Ÿå—,æˆ‘æƒ³å‘Šè¨´ä½ :**é€™ä¸æ˜¯ä½ çš„éŒ¯,ä½ æ²’æœ‰ã€Œä¸å¤ åŠªåŠ›ã€æˆ–ã€Œä¸å¤ å …å¼·ã€**ã€‚")
            summary_parts.append("\næ†‚é¬±æƒ…ç·’å¯èƒ½ä¾†è‡ª:ç”Ÿæ´»å£“åŠ›çš„ç´¯ç©ã€å¤±è½èˆ‡å¤±æœ›çš„ç–ŠåŠ ã€ç”Ÿç†å› ç´ (å¦‚è·çˆ¾è’™è®ŠåŒ–ã€ç¡çœ ä¸è¶³)ã€æˆ–æ˜¯**é•·æœŸå¿½ç•¥è‡ªå·±éœ€æ±‚**çš„çµæœã€‚")
            summary_parts.append("\n**æº«æŸ”çš„æ‡‰å°æ–¹å¼:**")
            summary_parts.append("â€¢ **å¾®è¡Œå‹•è¨ˆç•«**: ä¸è¦æœŸå¾…è‡ªå·±ç«‹åˆ»ã€ŒæŒ¯ä½œã€ã€‚å¾**æœ€å°çš„è¡Œå‹•**é–‹å§‹:ä»Šå¤©åªè¦èµ·åºŠæ´—è‡‰ã€å‡ºé–€è²·æ¯é£²æ–™ã€æˆ–çµ¦æœ‹å‹å‚³å€‹è¨Šæ¯ã€‚**è¡Œå‹•æœƒå‰µé€ å‹•åŠ›**,è€Œéç­‰å‹•åŠ›å‡ºç¾æ‰è¡Œå‹•ã€‚")
            summary_parts.append("â€¢ **æƒ…ç·’å‘½åç·´ç¿’**: æ¯å¤©èŠ±2åˆ†é˜,ç”¨**å…·é«”çš„è©å½™æè¿°ä½ çš„æ„Ÿå—**(ä¸åªæ˜¯ã€Œé›£éã€,è€Œæ˜¯ã€Œç©ºè™›çš„ã€ã€ã€Œç–²æ†Šçš„ã€ã€ã€Œå¤±æœ›çš„ã€)ã€‚å‘½åæƒ…ç·’èƒ½é™ä½å®ƒ 30% çš„å¼·åº¦,é€™æ˜¯ç¥ç¶“ç§‘å­¸è­‰å¯¦çš„ç¾è±¡ã€‚")
            summary_parts.append("â€¢ **ç¤¾äº¤é€£çµ,å³ä½¿å¾ˆå°**: æ†‚é¬±æœƒè®“ä½ æƒ³ç¸®å›æ®¼è£¡,ä½†**éš”é›¢æœƒåŠ æ·±æ†‚é¬±**ã€‚ä¸éœ€è¦ç¤¾äº¤æ´»å‹•,åªè¦ã€Œ**åœ¨äººç¾¤ä¸­å­˜åœ¨**ã€å°±å¥½(å»å’–å•¡å»³è®€æ›¸ã€è·Ÿå®¶äººåƒé “é£¯ã€å‚³è¨Šæ¯çµ¦æœ‹å‹)ã€‚")
            summary_parts.append("â€¢ **è‡ªæˆ‘æ…ˆæ‚²,è€Œéè‡ªæˆ‘æ‰¹åˆ¤**: ç•¶è² é¢æƒ³æ³•å‡ºç¾(ã€Œæˆ‘å¥½å»¢ã€ã€ã€Œæˆ‘ä»€éº¼éƒ½åšä¸å¥½ã€),è©¦è‘—å•è‡ªå·±:**å¦‚æœå¥½å‹é€™æ¨£èªªè‡ªå·±,æˆ‘æœƒæ€éº¼å®‰æ…°ä»–?** ç„¶å¾Œ,ç”¨åŒæ¨£çš„æº«æŸ”å°å¾…è‡ªå·±ã€‚")
            summary_parts.append("\n**é‡è¦æé†’**: å¦‚æœä½è½æƒ…ç·’**æŒçºŒè¶…éå…©é€±ã€å½±éŸ¿æ—¥å¸¸åŠŸèƒ½ã€æˆ–å‡ºç¾è‡ªå‚·å¿µé ­**,è«‹å‹™å¿…å°‹æ±‚å°ˆæ¥­å”åŠ©ã€‚æ†‚é¬±ç—‡æ˜¯å¯ä»¥æ²»ç™‚çš„,ä½ **å€¼å¾—ç²å¾—å°ˆæ¥­çš„æ”¯æŒ**ã€‚")
            
        elif top_emotion == "æ†¤æ€’ç…©èº":
            summary_parts.append("\nğŸ’¡ **å¯«çµ¦æ†¤æ€’çš„ä½ **")
            summary_parts.append("æ†¤æ€’æ˜¯ä¸€ç¨®**åŠ›é‡å¼·å¤§çš„æƒ…ç·’ä¿¡è™Ÿ**,å®ƒåœ¨å‘Šè¨´ä½ :ã€Œæœ‰ä»€éº¼ä¸å°å‹äº†ã€ã€ã€Œæˆ‘çš„ç•Œç·šè¢«ä¾µçŠ¯äº†ã€ã€ã€Œæˆ‘çš„éœ€æ±‚æ²’æœ‰è¢«çœ‹è¦‹ã€ã€‚æ†¤æ€’æœ¬èº«ä¸æ˜¯å•é¡Œ,**å¦‚ä½•ç†è§£èˆ‡è¡¨é”å®ƒæ‰æ˜¯é—œéµ**ã€‚")
            summary_parts.append("\nå¾å¿ƒç†å­¸ä¾†çœ‹,æ†¤æ€’çš„åº•å±¤å¸¸å¸¸æ˜¯:**ç„¡åŠ›æ„Ÿã€å—å‚·ã€ææ‡¼ã€æˆ–é•·æœŸç´¯ç©çš„å§”å±ˆ**ã€‚å®ƒåƒæ˜¯å†°å±±éœ²å‡ºæ°´é¢çš„ä¸€è§’,åº•ä¸‹è—è‘—æ›´æ·±å±¤çš„æƒ…ç·’ã€‚")
            summary_parts.append("\n**ç†è§£ä½ çš„æ†¤æ€’:**")
            summary_parts.append("â€¢ **æ†¤æ€’æ—¥èªŒ**: è¨˜éŒ„æ¯æ¬¡ç”Ÿæ°£çš„æƒ…å¢ƒ:èª°?ä»€éº¼äº‹?ä½ çš„**èº«é«”åæ‡‰**(å¿ƒè·³åŠ é€Ÿã€è‚Œè‚‰ç·Šç¹ƒ)?ä½ çš„**æƒ³æ³•**(ä»–æ†‘ä»€éº¼ã€å¤ªä¸å…¬å¹³)?ä½ çš„**è¡Œå‹•**(å¤§å¼ã€æ‘”é–€ã€å†·æˆ°)?")
            summary_parts.append("  ä¸€é€±å¾Œå›é¡§,ä½ æœƒçœ‹è¦‹**è§¸ç™¼æ¨¡å¼**:æ˜¯ç‰¹å®šçš„äººäº‹ç‰©?é‚„æ˜¯ç•¶ä½ ç´¯äº†ã€é¤“äº†ã€å£“åŠ›å¤§æ™‚æ›´å®¹æ˜“ç”Ÿæ°£?")
            summary_parts.append("â€¢ **å†°å±±ç·´ç¿’**: ä¸‹æ¬¡ç”Ÿæ°£æ™‚,æš«åœä¸¦å•è‡ªå·±:ã€Œ**æ†¤æ€’åº•ä¸‹,æˆ‘çœŸæ­£çš„æ„Ÿå—æ˜¯ä»€éº¼?**ã€å¯èƒ½æ˜¯å—å‚·(è¦ºå¾—ä¸è¢«å°Šé‡)ã€ææ‡¼(æ“”å¿ƒå¤±å»æ§åˆ¶)ã€æ‚²å‚·(æœŸå¾…è½ç©º)ã€‚æ‰¾åˆ°çœŸæ­£çš„æƒ…ç·’,æ‰èƒ½æœ‰æ•ˆæºé€šã€‚")
            summary_parts.append("\n**å¥åº·çš„è¡¨é”æ–¹å¼:**")
            summary_parts.append("â€¢ **æš«åœæŠ€å·§**: ç•¶æ€’æ°£è¡ä¸Šä¾†,**çµ¦è‡ªå·±10åˆ†é˜**:æ·±å‘¼å¸ã€é›¢é–‹ç¾å ´ã€å–æ¯æ°´ã€‚æƒ…ç·’é«˜å³°é€šå¸¸åœ¨ **90 ç§’å…§**æœƒè‡ªç„¶ä¸‹é™,ä¸è¦åœ¨é«˜å³°æ™‚åšæ±ºå®šæˆ–èªªè©±ã€‚")
            summary_parts.append("â€¢ **ã€Œæˆ‘è¨Šæ¯ã€æºé€š**: ä¸èªªã€Œä½ ç¸½æ˜¯...ã€(æŒ‡è²¬),æ”¹èªªã€Œç•¶...ç™¼ç”Ÿæ™‚,æˆ‘æ„Ÿè¦º...,å› ç‚ºæˆ‘éœ€è¦...ã€ã€‚ä¾‹å¦‚:ã€Œç•¶ä½ æ²’æœ‰å›æˆ‘è¨Šæ¯æ™‚,æˆ‘æ„Ÿè¦ºè¢«å¿½è¦–,å› ç‚ºæˆ‘éœ€è¦çŸ¥é“ä½ æ˜¯å¦æ”¶åˆ°é‡è¦è¨Šæ¯ã€‚ã€")
            summary_parts.append("â€¢ **é‹å‹•é‡‹æ”¾**: æ†¤æ€’æ˜¯**é«˜èƒ½é‡æƒ…ç·’**,éœ€è¦å‡ºå£ã€‚è·‘æ­¥ã€æ‹³æ“Šã€å¤§æƒé™¤éƒ½èƒ½å¹«åŠ©é‡‹æ”¾,è®“èº«é«”ä»£è¬æ‰å£“åŠ›è·çˆ¾è’™ã€‚")
            
        elif top_emotion == "å£“åŠ›ç–²æ†Š":
            summary_parts.append("\nğŸ’¡ **å¯«çµ¦ç–²æ†Šçš„ä½ **")
            summary_parts.append("ç–²æ†Šæ˜¯èº«é«”èˆ‡å¿ƒéˆç™¼å‡ºçš„**ç´…è‰²è­¦å ±**:ã€Œæˆ‘éœ€è¦ä¼‘æ¯äº†ã€ã€ã€Œè² è·è¶…è¼‰äº†ã€ã€‚ç¾ä»£ç¤¾æœƒå¸¸æŠŠå¿™ç¢Œç•¶ç¾å¾·,ä½†**æŒçºŒé€æ”¯æœƒå°è‡´è€—ç«­(Burnout)**,å½±éŸ¿å¥åº·ã€å·¥ä½œå’Œäººéš›é—œä¿‚ã€‚")
            summary_parts.append("\nå¿ƒç†å­¸ç ”ç©¶é¡¯ç¤º,å£“åŠ›ç–²æ†Šä¸åªæ˜¯ã€Œåšå¤ªå¤šã€,æ›´å¸¸æ˜¯:**åšäº†ä¸é‡è¦çš„äº‹å¤ªå¤šã€ç„¡æ³•æŒæ§çš„äº‹å¤ªå¤šã€ä»¥åŠä¼‘æ¯çš„è³ªé‡ä¸è¶³**ã€‚")
            summary_parts.append("\n**å£“åŠ›ç®¡ç†ç­–ç•¥:**")
            summary_parts.append("â€¢ **èƒ½é‡å¯©è¨ˆ**: åˆ—å‡ºä½ **ä¸€é€±çš„æ´»å‹•**,æ¨™è¨»æ¯é …æ´»å‹•æ˜¯ã€Œå……é›»ã€(çµ¦ä½ èƒ½é‡)é‚„æ˜¯ã€Œè€—é›»ã€(æ¶ˆè€—èƒ½é‡)ã€‚ä½ æœƒé©šè¨åœ°ç™¼ç¾,æœ‰äº›ä½ ä»¥ç‚ºçš„ã€Œä¼‘æ¯ã€(å¦‚æ»‘æ‰‹æ©Ÿ)å…¶å¯¦ä¹Ÿåœ¨è€—é›»ã€‚ç›®æ¨™æ˜¯**å¢åŠ å……é›»æ´»å‹•,æ¸›å°‘éå¿…è¦çš„è€—é›»æ´»å‹•**ã€‚")
            summary_parts.append("â€¢ **å„ªå…ˆé †åºçŸ©é™£**: å°‡å¾…è¾¦äº‹é …åˆ†ç‚ºå››é¡:ã€Œç·Šæ€¥ä¸”é‡è¦ã€(å…ˆåš)ã€ã€Œé‡è¦ä¸ç·Šæ€¥ã€(æ’ç¨‹)ã€ã€Œç·Šæ€¥ä¸é‡è¦ã€(æˆæ¬Šæˆ–å¿«é€Ÿè™•ç†)ã€ã€Œä¸ç·Šæ€¥ä¸é‡è¦ã€(åˆªé™¤)ã€‚å¤§éƒ¨åˆ†å£“åŠ›ä¾†è‡ª**ç¬¬ä¸‰é¡å‡æ€§ç·Šæ€¥äº‹ä»¶**ä½”æ“šå¤ªå¤šæ™‚é–“ã€‚")
            summary_parts.append("â€¢ **å¾®ä¼‘æ¯ç¿’æ…£**: ä¸è¦ç­‰åˆ°å´©æ½°æ‰ä¼‘æ¯ã€‚æ¯å·¥ä½œ **50 åˆ†é˜ä¼‘æ¯ 10 åˆ†é˜**,çœŸæ­£é›¢é–‹åº§ä½:ä¼¸å±•ã€å–æ°´ã€çœ‹çª—å¤–ã€åšå¹¾æ¬¡æ·±å‘¼å¸ã€‚ç ”ç©¶é¡¯ç¤º,é »ç¹çš„å¾®ä¼‘æ¯æ¯”é•·æ™‚é–“å·¥ä½œå¾Œçš„é•·ä¼‘æ¯**æ›´èƒ½ç¶­æŒç”Ÿç”¢åŠ›èˆ‡å¿ƒç†å¥åº·**ã€‚")
            summary_parts.append("â€¢ **ç¡çœ å„ªå…ˆ**: ç–²æ†Šæ™‚æœ€éœ€è¦çš„æ˜¯**å„ªè³ªç¡çœ **ã€‚å»ºç«‹ç¡å‰å„€å¼:ç¡å‰1å°æ™‚é—œé–‰è¢å¹•ã€èª¿æš—ç‡ˆå…‰ã€åšäº›æ”¾é¬†æ´»å‹•(é–±è®€ã€å†¥æƒ³ã€è¼•æŸ”ä¼¸å±•)ã€‚ç¡çœ æ˜¯**æœ€å¼·å¤§çš„ä¿®å¾©æ©Ÿåˆ¶**ã€‚")
            summary_parts.append("\n**é•·æœŸæ€è€ƒ**: å¦‚æœå£“åŠ›å·²æ˜¯å¸¸æ…‹,å¯èƒ½éœ€è¦é‡æ–°æª¢è¦–ç”Ÿæ´»çµæ§‹:é€™ä»½å·¥ä½œ/é€™ç¨®ç”Ÿæ´»æ–¹å¼çœŸçš„é©åˆæˆ‘å—?æˆ‘çš„**åƒ¹å€¼è§€èˆ‡ç”Ÿæ´»æ˜¯å¦ä¸€è‡´**?æœ‰æ™‚å€™,æ”¹è®Šç’°å¢ƒæ¯”æ”¹è®Šè‡ªå·±æ›´æœ‰æ•ˆã€‚")
            
        elif top_emotion == "å¿«æ¨‚æ»¿è¶³":
            summary_parts.append("\nâœ¨ **çè²´çš„å…‰äº®æ™‚åˆ»**")
            summary_parts.append("ä½ çš„å°è©±ä¸­å……æ»¿æ­£å‘æƒ…ç·’,é€™æ˜¯å¤šéº¼ç¾å¥½çš„ç‹€æ…‹!ä½†æˆ‘æƒ³æé†’ä½ ,**å¿«æ¨‚ä¸éœ€è¦ç†ç”±,ä¹Ÿä¸éœ€è¦æ„Ÿåˆ°æ„§ç–š**ã€‚æœ‰äº›äººåœ¨å¿«æ¨‚æ™‚æœƒè¦ºå¾—ã€Œæˆ‘æ˜¯ä¸æ˜¯å¤ªå¹¸é‹äº†ã€ã€ã€Œé€™ä¸æœƒæŒä¹…çš„ã€,é€™ç¨®æƒ³æ³•åè€Œæœƒå‰Šå¼±å¿«æ¨‚ã€‚")
            summary_parts.append("\nå¿ƒç†å­¸ä¸­æœ‰å€‹æ¦‚å¿µå«ã€Œ**å“å‘³(Savoring)**ã€,æŒ‡çš„æ˜¯**æœ‰æ„è­˜åœ°å»¶é•·èˆ‡åŠ æ·±æ­£å‘é«”é©—**ã€‚ç•¶å¥½äº‹ç™¼ç”Ÿæ™‚,å¤§éƒ¨åˆ†äººæœƒå¿«é€Ÿå¸¶é,ä½†ä½ å¯ä»¥:")
            summary_parts.append("â€¢ **æ…¢ä¸‹ä¾†**: ç•¶ä½ æ„Ÿåˆ°å¿«æ¨‚æ™‚,**æš«åœ 30 ç§’**,å‘Šè¨´è‡ªå·±ã€Œæˆ‘ç¾åœ¨å¾ˆå¿«æ¨‚ã€,æ„Ÿå—é€™ä»½å–œæ‚…åœ¨èº«é«”çš„å“ªå€‹éƒ¨ä½(å¿ƒå£æš–æš–çš„?è‚©è†€æ”¾é¬†äº†?å˜´è§’ä¸Šæš?)ã€‚")
            summary_parts.append("â€¢ **åˆ†äº«å–œæ‚…**: å‘ä»–äººè¿°èªªå¥½äº‹,èƒ½**å°‡å¿«æ¨‚æ”¾å¤§ 2 å€**ã€‚æ‰¾å€‹æœƒçœŸå¿ƒç‚ºä½ é–‹å¿ƒçš„äººåˆ†äº«,è€Œéæœƒæ½‘å†·æ°´çš„äººã€‚")
            summary_parts.append("â€¢ **å¿«æ¨‚è³‡æ–™åº«**: æ¯æ™šè¨˜ä¸‹ **3 ä»¶å¥½äº‹**,ç„¡è«–å¤šå°(é™½å…‰å¾ˆå¥½ã€åˆé¤å¾ˆç¾å‘³ã€æœ‹å‹çš„ä¸€å¥è©±)ã€‚å»ºç«‹é€™å€‹ã€Œ**å¿ƒç†å­˜æ¬¾**ã€,åœ¨ä½æ½®æ™‚å¯ä»¥æé ˜ã€‚")
            summary_parts.append("â€¢ **æ¢ç´¢å¿«æ¨‚æºé ­**: æ€è€ƒ**ä»€éº¼å¸¶ä¾†äº†é€™äº›å¿«æ¨‚**?æ˜¯æˆå°±æ„Ÿ?æ˜¯é€£çµæ„Ÿ?æ˜¯è‡ªä¸»æ€§?æ˜¯æ–°é®®æ„Ÿ?äº†è§£è‡ªå·±çš„å¿«æ¨‚å…¬å¼,ä½ å°±èƒ½**ä¸»å‹•è¨­è¨ˆæ›´å¤šå¿«æ¨‚**ã€‚")
            summary_parts.append("\nç ”ç©¶é¡¯ç¤º,**æ„Ÿæ©ã€å–„è¡Œã€èˆ‡äººé€£çµã€æŠ•å…¥ç†±æ„›çš„äº‹ç‰©**,æ˜¯æœ€èƒ½æŒçºŒæå‡å¹¸ç¦æ„Ÿçš„å››å¤§å› ç´ ã€‚ä½ å·²ç¶“åœ¨æ­£å‘çš„è»Œé“ä¸Š,ç¹¼çºŒä¿æŒ,ä¹Ÿåˆ¥å¿˜äº†å°‡é€™ä»½å…‰äº®åˆ†äº«çµ¦ä»–äººã€‚")
            
        elif top_emotion == "å¹³éœæ”¾é¬†":
            summary_parts.append("\nâœ¨ **å…§åœ¨çš„å¹³éœåŠ›é‡**")
            summary_parts.append("èƒ½å¤ ç¶­æŒå¹³éœ,åœ¨é€™å€‹å¿«ç¯€å¥ã€é«˜å£“åŠ›çš„ä¸–ç•Œè£¡æ˜¯**é›£èƒ½å¯è²´çš„èƒ½åŠ›**ã€‚é€™ä¸æ˜¯å†·æ¼ æˆ–éº»æœ¨,è€Œæ˜¯ä¸€ç¨®**èˆ‡ä¸–ç•Œä¿æŒé©ç•¶è·é›¢çš„æ™ºæ…§**ã€‚")
            summary_parts.append("\nå¿ƒç†å­¸å°‡é€™ç¨®ç‹€æ…‹ç¨±ç‚ºã€Œ**å¿ƒç†éŸŒæ€§(Resilience)**ã€çš„è¡¨ç¾:ä½ èƒ½åœ¨é¢¨æµªä¸­ä¿æŒå…§åœ¨ç©©å®š,ä¸è¼•æ˜“è¢«å¤–ç•Œæ“¾å‹•ã€‚é€™é€šå¸¸ä¾†è‡ª:**è‡ªæˆ‘è¦ºå¯Ÿã€æ¥ç´ç¾å¯¦ã€ä»¥åŠå°ç”Ÿæ´»çš„æŒæ§æ„Ÿ**ã€‚")
            summary_parts.append("\n**æ·±åŒ–ä½ çš„å¹³éœ:**")
            summary_parts.append("â€¢ **æ­£å¿µç·´ç¿’**: æ¯å¤© **5-10 åˆ†é˜**,å°ˆæ³¨æ–¼å‘¼å¸æˆ–èº«é«”æ„Ÿè¦º,ä¸è©•åˆ¤ã€ä¸æŠ“å–ã€ä¸æŠ—æ‹’ã€‚é€™èƒ½å°‡ä½ çš„å¹³éœ**å¾ç‹€æ…‹è®Šæˆç‰¹è³ª**,æˆç‚ºå…§åœ¨ç©©å®šçš„è³‡æºã€‚")
            summary_parts.append("â€¢ **åƒ¹å€¼è§€å°é½Š**: å¹³éœå¸¸ä¾†è‡ªæ–¼ã€Œæˆ‘çŸ¥é“ä»€éº¼å°æˆ‘é‡è¦,æˆ‘æ­£èµ°åœ¨å°çš„è·¯ä¸Šã€ã€‚å®šæœŸæª¢è¦–:**æˆ‘çš„ç”Ÿæ´»èˆ‡æˆ‘çš„åƒ¹å€¼è§€ä¸€è‡´å—**?ä¸ä¸€è‡´æ™‚æœƒç”¢ç”Ÿå…§åœ¨è¡çª,ä¸€è‡´æ™‚æœƒæ„Ÿåˆ°å¹³å’Œã€‚")
            summary_parts.append("â€¢ **æ¥ç´ç·´ç¿’**: å¹³éœä¸æ˜¯æ§åˆ¶ä¸€åˆ‡,è€Œæ˜¯**æ¥ç´ç„¡æ³•æ§åˆ¶çš„éƒ¨åˆ†**ã€‚å°æ–¼ç„¡æ³•æ”¹è®Šçš„äº‹(éå»ã€ä»–äººã€æŸäº›çµæœ),ç·´ç¿’èªªã€Œæˆ‘æ¥ç´å®ƒçš„å­˜åœ¨ã€,æŠŠèƒ½é‡æ”¾åœ¨ä½ èƒ½æ”¹è®Šçš„åœ°æ–¹ã€‚")
            summary_parts.append("\nä½ çš„å¹³éœæ˜¯**çµ¦è‡ªå·±å’Œä»–äººçš„ç¦®ç‰©**ã€‚åœ¨æ··äº‚çš„æ™‚åˆ»,ä½ èƒ½æˆç‚ºç©©å®šçš„åŠ›é‡ã€‚ç¹¼çºŒåŸ¹é¤Šé€™ä»½ç‰¹è³ª,å®ƒæœƒåœ¨ä½ æœ€éœ€è¦æ™‚æˆç‚ºé¿é¢¨æ¸¯ã€‚")
            
        elif top_emotion == "å›°æƒ‘è¿·èŒ«":
            summary_parts.append("\nğŸ’¡ **åœ¨è¿·éœ§ä¸­å‰è¡Œ**")
            summary_parts.append("å›°æƒ‘å’Œè¿·èŒ«æ˜¯**è½‰è®ŠæœŸçš„æ¨™èªŒ**,ä»£è¡¨èˆŠçš„æ¡†æ¶ä¸å†é©ç”¨,æ–°çš„å°šæœªæˆå½¢ã€‚é€™å€‹éšæ®µå¾ˆä¸èˆ’æœ,å› ç‚ºäººé¡å¤©ç”Ÿæ¸´æœ›ç¢ºå®šæ€§,ä½†è«‹è¨˜ä½:**æ‰€æœ‰æˆé•·éƒ½å§‹æ–¼ä¸ç¢ºå®š**ã€‚")
            summary_parts.append("\nå¿ƒç†å­¸å®¶ William Bridges çš„ã€Œè½‰è®Šä¸‰éšæ®µã€ç†è«–æŒ‡å‡º:çµæŸâ†’æ··äº‚ä¸­ç«‹å€â†’æ–°é–‹å§‹ã€‚ä½ ç¾åœ¨å¯èƒ½åœ¨**ã€Œæ··äº‚ä¸­ç«‹å€ã€**,é€™è£¡å……æ»¿å›°æƒ‘,ä½†ä¹Ÿå……æ»¿å¯èƒ½æ€§ã€‚")
            summary_parts.append("\n**åœ¨è¿·èŒ«ä¸­æ‰¾åˆ°æ–¹å‘:**")
            summary_parts.append("â€¢ **è¡¨é”æ€§æ›¸å¯«**: æ¯å¤© **10-15 åˆ†é˜è‡ªç”±æ›¸å¯«**,ä¸ä¿®æ”¹ã€ä¸æ‰¹åˆ¤,è®“æ½›æ„è­˜èªªè©±ã€‚å¯«ä¸‹ã€Œæˆ‘å›°æƒ‘çš„æ˜¯...ã€ã€ã€Œæˆ‘å®³æ€•çš„æ˜¯...ã€ã€ã€Œæˆ‘æ¸´æœ›çš„æ˜¯...ã€ã€‚é€šå¸¸å¯«è‘—å¯«è‘—,**ç­”æ¡ˆæœƒè‡ªå·±æµ®ç¾**ã€‚")
            summary_parts.append("â€¢ **å¯¦é©—å¿ƒæ…‹**: ä¸è¦æ€¥è‘—æ‰¾ã€Œæ­£ç¢ºç­”æ¡ˆã€ã€‚æŠŠé€™æ®µæ™‚é–“ç•¶ä½œ**å¯¦é©—æœŸ**:å˜—è©¦ä¸åŒçš„å¯èƒ½(å‰¯æ¥­ã€èˆˆè¶£ã€äººéš›åœˆ),è§€å¯Ÿå“ªäº›è®“ä½ æœ‰èƒ½é‡ã€æœ‰æ„ç¾©ã€‚**è¡Œå‹•æœƒå¸¶ä¾†ç­”æ¡ˆ**,è€Œéæ€è€ƒã€‚")
            summary_parts.append("â€¢ **å°è©±æ¾„æ¸…**: æ‰¾ä¿¡ä»»çš„äºº(æœ‹å‹ã€å°å¸«ã€è«®å•†å¸«)æ·±åº¦å°è©±ã€‚**èªªå‡ºå£çš„éç¨‹æœ¬èº«å°±æ˜¯æ•´ç†**,ä»–äººçš„æå•èƒ½å¹«ä½ çœ‹è¦‹ç›²é»ã€‚ä¸è¦æ“”å¿ƒã€Œéº»ç…©åˆ¥äººã€,çœŸæ­£çš„æœ‹å‹æœƒæ¨‚æ„é™ªä¼´ä½ ã€‚")
            summary_parts.append("â€¢ **å‘å…§æ¢å•**: å•è‡ªå·±:**å¦‚æœæˆ‘çŸ¥é“ç­”æ¡ˆ,é‚£æœƒæ˜¯ä»€éº¼?** å¦‚æœå¤±æ•—ä¸å¯èƒ½,æˆ‘æœƒé¸æ“‡ä»€éº¼?** æœ‰æ™‚å€™,ä½ å…¶å¯¦çŸ¥é“ç­”æ¡ˆ,åªæ˜¯**é‚„æ²’æº–å‚™å¥½æ‰¿èªæˆ–è¡Œå‹•**ã€‚")
            summary_parts.append("\n**çµ¦è‡ªå·±æ™‚é–“**: è¿·èŒ«æœŸå¯èƒ½æŒçºŒæ•¸é€±åˆ°æ•¸æœˆ,é€™æ˜¯æ­£å¸¸çš„ã€‚ä¸è¦å¼·è¿«è‡ªå·±ã€Œå¿«é»æƒ³æ¸…æ¥šã€ã€‚**ä¿¡ä»»éç¨‹,ç­”æ¡ˆæœƒåœ¨å°çš„æ™‚å€™å‡ºç¾**ã€‚è€Œä¸”,æœ‰æ™‚å€™æœ€å¥½çš„é¸æ“‡ä¸æ˜¯ã€Œæƒ³æ¸…æ¥šã€,è€Œæ˜¯ã€Œåœ¨è¡Œå‹•ä¸­é€æ¼¸æ¸…æ™°ã€ã€‚")
    
    # æƒ…ç·’å¤šæ¨£æ€§åˆ†æ
    if len(emotion_freq) >= 3:
        top_3_emotions = [k for k, v in sorted(emotion_freq.items(), key=lambda x: x[1], reverse=True)[:3]]
        summary_parts.append(f"\nğŸ¨ **ä½ çš„æƒ…ç·’è‰²ç›¤**")
        summary_parts.append(f"ä½ çš„æƒ…ç·’æ¨£è²Œå‘ˆç¾è±å¯Œçš„å¤šå…ƒæ€§,ä¸»è¦çš„ä¸‰ç¨®è‰²èª¿æ˜¯:**{top_3_emotions[0]}**({emotion_freq[top_3_emotions[0]]}æ¬¡)ã€**{top_3_emotions[1]}**({emotion_freq[top_3_emotions[1]]}æ¬¡)ã€**{top_3_emotions[2]}**({emotion_freq[top_3_emotions[2]]}æ¬¡)ã€‚")
        summary_parts.append("\né€™ç¨®å¤šæ¨£æ€§é¡¯ç¤ºä½ æ˜¯ä¸€å€‹**æƒ…æ„Ÿè±å¯Œçš„äºº**,èƒ½å¤ é«”é©—ç”Ÿæ´»çš„å„ç¨®å±¤æ¬¡ã€‚æƒ…ç·’å¥åº·ä¸æ˜¯ã€Œæ°¸é å¿«æ¨‚ã€æˆ–ã€Œæ²’æœ‰è² é¢æƒ…ç·’ã€,è€Œæ˜¯:")
        summary_parts.append("â€¢ **è¦ºå¯Ÿ**: ä½ èƒ½æ„è­˜åˆ°è‡ªå·±çš„æƒ…ç·’å—?")
        summary_parts.append("â€¢ **æ¥ç´**: ä½ èƒ½å…è¨±æ‰€æœ‰æƒ…ç·’å­˜åœ¨,è€Œä¸æ‰¹åˆ¤å—?")
        summary_parts.append("â€¢ **è¡¨é”**: ä½ èƒ½ç”¨å¥åº·çš„æ–¹å¼è¡¨é”æƒ…ç·’å—?")
        summary_parts.append("â€¢ **èª¿ç¯€**: ç•¶æƒ…ç·’éæ–¼å¼·çƒˆæ™‚,ä½ èƒ½æ‰¾åˆ°æ–¹æ³•èª¿ç¯€å—?")
        summary_parts.append("\nä½ æ­£åœ¨é€éå°è©±ç·´ç¿’é€™äº›èƒ½åŠ›,é€™æœ¬èº«å°±æ˜¯**æƒ…ç·’æ™ºæ…§(Emotional Intelligence)**çš„é«”ç¾ã€‚ç¹¼çºŒé€™æ®µè‡ªæˆ‘æ¢ç´¢çš„æ—…ç¨‹ã€‚")
    
    # æ ¸å¿ƒè­°é¡Œçš„æ·±åº¦åˆ†æ
    if topics:
        top_topic = max(topics.items(), key=lambda x: x[1])[0]
        topic_score = topics[top_topic]
        
        summary_parts.append(f"\nğŸ¯ **ç”Ÿå‘½çš„æ ¸å¿ƒå‘½é¡Œ**")
        summary_parts.append(f"ä½ æœ€é—œæ³¨çš„ç”Ÿå‘½é ˜åŸŸæ˜¯ã€Œ**{top_topic}**ã€(é—œæ³¨åº¦æŒ‡æ•¸: {round(topic_score, 1)})ã€‚é€™å€‹ä¸»é¡Œåœ¨ä½ çš„å°è©±ä¸­åè¦†å‡ºç¾,é¡¯ç¤ºå®ƒå°ä½ çš„ç”Ÿæ´»æœ‰è‘—**æ·±åˆ»çš„å½±éŸ¿**ã€‚")
        
        if top_topic == "å·¥ä½œè·å ´":
            summary_parts.append("\nå·¥ä½œä¸åªæ˜¯è¬€ç”Ÿå·¥å…·,å®ƒå¾€å¾€èˆ‡**è‡ªæˆ‘åƒ¹å€¼ã€æˆå°±æ„Ÿã€äººç”Ÿæ„ç¾©**ç·Šå¯†ç›¸é€£ã€‚ç•¶å·¥ä½œæˆç‚ºä¸»è¦é—œæ³¨é»,å€¼å¾—æ·±å…¥æ€è€ƒ:")
            summary_parts.append("â€¢ **æ„ç¾©æ„Ÿ**: é€™ä»½å·¥ä½œèˆ‡ä½ çš„**é•·æœŸç›®æ¨™ã€åƒ¹å€¼è§€**ä¸€è‡´å—?é‚„æ˜¯åªæ˜¯ã€Œé‚„å¯ä»¥ã€æˆ–ã€Œé‚„èƒ½å¿å—ã€?")
            summary_parts.append("â€¢ **æˆé•·ç©ºé–“**: ä½ åœ¨å…¶ä¸­å­¸åˆ°æ–°æŠ€èƒ½ã€æ‹“å±•èƒ½åŠ›å—?é‚„æ˜¯å·²ç¶“é€²å…¥èˆ’é©å€æˆ–å€¦æ€ æœŸ?")
            summary_parts.append("â€¢ **å·¥ä½œèˆ‡è‡ªæˆ‘çš„é—œä¿‚**: ä½ æ˜¯å¦éåº¦å°‡**è‡ªæˆ‘åƒ¹å€¼ç¶å®šåœ¨å·¥ä½œè¡¨ç¾**ä¸Š?è¨˜ä½,ä½ çš„åƒ¹å€¼ä¸ç­‰æ–¼ä½ çš„ç”¢å‡ºã€‚")
            summary_parts.append("â€¢ **ç•Œç·šè¨­å®š**: èƒ½å¦æ¸…æ¥šå€åˆ†**å·¥ä½œæ™‚é–“èˆ‡ç§äººæ™‚é–“**?å»ºç«‹ã€Œä¸‹ç­å„€å¼ã€(æ›è¡£æœã€é‹å‹•ã€åšæ™šé¤)å¹«åŠ©å¤§è…¦åˆ‡æ›ã€‚")
            summary_parts.append("\nå¦‚æœå·¥ä½œå¸¶ä¾†æŒçºŒçš„å£“åŠ›æˆ–ä¸æ»¿,å¯ä»¥æ€è€ƒ:**é€™æ˜¯ç’°å¢ƒçš„å•é¡Œ(å¯ä»¥è½‰æ›),é‚„æ˜¯æœŸå¾…çš„å•é¡Œ(å¯ä»¥èª¿æ•´)?** æœ‰æ™‚æ”¹è®Šç’°å¢ƒ,æœ‰æ™‚æ”¹è®Šå¿ƒæ…‹,å…©è€…éƒ½æ˜¯æœ‰æ•ˆçš„ç­–ç•¥ã€‚")
            
        elif top_topic == "äººéš›é—œä¿‚":
            summary_parts.append("\näººéš›é—œä¿‚æ˜¯**æƒ…ç·’çš„ä¸»è¦ä¾†æº**,ä¹Ÿæ˜¯å¿ƒç†å¥åº·çš„é—œéµå› ç´ ã€‚å“ˆä½›å¤§å­¸ 75 å¹´çš„å¹¸ç¦ç ”ç©¶ç™¼ç¾:**è‰¯å¥½çš„é—œä¿‚æ˜¯å¹¸ç¦èˆ‡å¥åº·çš„æœ€å¤§é æ¸¬å› å­**ã€‚")
            summary_parts.append("ä½†é—œä¿‚ä¹Ÿæ˜¯å£“åŠ›æºã€‚ç•¶äººéš›æˆç‚ºä¸»è¦å›°æ“¾,å€¼å¾—æ¢ç´¢:")
            summary_parts.append("â€¢ **ç•Œç·šè­°é¡Œ**: ä½ æ˜¯å¦æ¸…æ¥šè‡ªå·±çš„ç•Œç·š?èƒ½æº«å’Œä½†å …å®šåœ°èªªã€Œä¸ã€å—?é‚„æ˜¯ç¸½æ˜¯**éåº¦é…åˆã€å£“æŠ‘éœ€æ±‚**?")
            summary_parts.append("â€¢ **ä¾é™„æ¨¡å¼**: ä½ åœ¨é—œä¿‚ä¸­çš„æ¨¡å¼æ˜¯ä»€éº¼?**ç„¦æ…®å‹**(éåº¦æ“”å¿ƒè¢«æ‹‹æ£„)ã€**è¿´é¿å‹**(ä¿æŒè·é›¢ä»¥è‡ªä¿)ã€é‚„æ˜¯**å®‰å…¨å‹**(èˆ’é©åœ°è¦ªè¿‘ä¹Ÿèƒ½ç¨ç«‹)?äº†è§£è‡ªå·±çš„ä¾é™„é¢¨æ ¼,èƒ½å¹«åŠ©ä½ ç†è§£é—œä¿‚ä¸­çš„åæ‡‰ã€‚")
            summary_parts.append("â€¢ **é—œä¿‚ç›¤é»**: å°‡ä½ çš„äººéš›é—œä¿‚åˆ†é¡:å“ªäº›è®“ä½ **å……èƒ½**(ç›¸è™•å¾Œæ„Ÿåˆ°é–‹å¿ƒã€è¢«ç†è§£)?å“ªäº›è®“ä½ **è€—èƒ½**(ç›¸è™•å¾Œæ„Ÿåˆ°ç–²æ†Šã€å§”å±ˆ)?æœ‰æ„è­˜åœ°æŠ•è³‡å……èƒ½é—œä¿‚,æ¸›å°‘è€—èƒ½äº’å‹•ã€‚")
            summary_parts.append("â€¢ **æºé€šæŠ€å·§**: å¾ˆå¤šè¡çªä¾†è‡ª**æºé€šä¸è‰¯**,è€Œéæ ¹æœ¬å·®ç•°ã€‚å­¸ç¿’ã€Œéæš´åŠ›æºé€šã€:è§€å¯Ÿ(ä¸è©•åˆ¤)â†’æ„Ÿå—â†’éœ€æ±‚â†’è«‹æ±‚,èƒ½å¤§å¹…æ”¹å–„é—œä¿‚å“è³ªã€‚")
            summary_parts.append("\nè¨˜ä½:**ä½ ç„¡æ³•æ”¹è®Šä»–äºº,ä½†èƒ½æ”¹è®Šè‡ªå·±åœ¨é—œä¿‚ä¸­çš„ä½ç½®**ã€‚æœ‰æ™‚å€™,æœ€å¥åº·çš„é¸æ“‡æ˜¯é›¢é–‹ä¸å¥åº·çš„é—œä¿‚;æœ‰æ™‚å€™,æ˜¯å­¸ç¿’æ–°çš„ç›¸è™•æ–¹å¼ã€‚")
            
        elif top_topic == "è‡ªæˆ‘èªåŒ":
            summary_parts.append("\nã€Œæˆ‘æ˜¯èª°?ã€ã€Œæˆ‘è¦å¾€å“ªè£¡å»?ã€é€™äº›**å­˜åœ¨æ€§å•é¡Œ**æ˜¯äººç”Ÿé‡è¦çš„æ¢ç´¢ã€‚ç•¶è‡ªæˆ‘èªåŒæˆç‚ºæ ¸å¿ƒé—œæ³¨,ä½ æ­£è™•æ–¼**è‡ªæˆ‘æ•´åˆçš„é—œéµæœŸ**ã€‚")
            summary_parts.append("\nå¿ƒç†å­¸å®¶ Erik Erikson æå‡º,äººç”Ÿå„éšæ®µéƒ½æœ‰ä¸åŒçš„èªåŒä»»å‹™ã€‚**è‡ªæˆ‘èªåŒä¸æ˜¯æ‰¾åˆ°ã€Œæ¨™æº–ç­”æ¡ˆã€,è€Œæ˜¯æŒçºŒæ•´åˆç¶“é©—ã€åƒ¹å€¼è§€èˆ‡é¸æ“‡çš„éç¨‹**ã€‚")
            summary_parts.append("â€¢ **åƒ¹å€¼è§€æ¾„æ¸…**: åšã€Œ**åƒ¹å€¼è§€æ’åºç·´ç¿’**ã€:åˆ—å‡º 10-15 å€‹é‡è¦åƒ¹å€¼(å¦‚è‡ªç”±ã€å®¶åº­ã€æˆå°±ã€å‰µé€ ã€æœå‹™ã€èª å¯¦ã€å†’éšªç­‰),é¸å‡ºæœ€é‡è¦çš„ **5 å€‹**,ç„¶å¾Œæª¢è¦–:æˆ‘çš„ç”Ÿæ´»é«”ç¾é€™äº›åƒ¹å€¼å—?")
            summary_parts.append("â€¢ **å¤šå…ƒèº«åˆ†**: ä½ ä¸æ˜¯å–®ä¸€èº«åˆ†,è€Œæ˜¯**å¤šé‡è§’è‰²çš„çµ„åˆ**(å·¥ä½œè€…ã€æœ‹å‹ã€å­å¥³ã€ä¼´ä¾¶ã€å‰µä½œè€…...)ã€‚ç•¶æŸå€‹è§’è‰²å—æŒ«,è¨˜å¾—ä½ é‚„æœ‰å…¶ä»–èº«åˆ†ã€‚ä¸è¦è®“å–®ä¸€é ˜åŸŸå®šç¾©ä½ çš„å…¨éƒ¨åƒ¹å€¼ã€‚")
            summary_parts.append("â€¢ **æ•˜äº‹æ²»ç™‚**: å¯«ä¸‹ä½ çš„**äººç”Ÿæ•…äº‹**:é‡è¦è½‰æŠ˜é»ã€å½±éŸ¿ä½ çš„äººèˆ‡äº‹ã€ä½ çš„åƒ¹å€¼è§€å¾ä½•è€Œä¾†ã€‚é€éæ›¸å¯«,ä½ èƒ½çœ‹è¦‹è‡ªå·±çš„ä¸»ç·šèˆ‡ç™¼å±•è»Œè·¡ã€‚")
            summary_parts.append("â€¢ **å¯¦é©—èˆ‡æ¢ç´¢**: èªåŒä¸æ˜¯ã€Œæƒ³å‡ºä¾†ã€çš„,è€Œæ˜¯**åšå‡ºä¾†**çš„ã€‚å˜—è©¦æ–°çš„èˆˆè¶£ã€è§’è‰²ã€ç’°å¢ƒ,åœ¨è¡Œå‹•ä¸­è§€å¯Ÿã€Œä»€éº¼è®“æˆ‘æ„Ÿåˆ°**çœŸå¯¦**ã€**æœ‰æ„ç¾©**ã€**æœ‰æ´»åŠ›**ã€ã€‚")
            summary_parts.append("\n**çµ¦è‡ªå·±è€å¿ƒ**: è‡ªæˆ‘èªåŒçš„æ¢ç´¢å¯èƒ½æŒçºŒæ•¸å¹´,å°¤å…¶åœ¨äººç”Ÿè½‰æ›æœŸ(ç•¢æ¥­ã€æ›å·¥ä½œã€å¤±æˆ€ã€æ¬å®¶)æœƒç‰¹åˆ¥å¼·çƒˆã€‚**é€™ä¸æ˜¯å±æ©Ÿ,è€Œæ˜¯æˆé•·çš„é‚€è«‹**ã€‚å…è¨±è‡ªå·±åœ¨ä¸ç¢ºå®šä¸­å‰è¡Œ,ç­”æ¡ˆæœƒé€æ¼¸æ¸…æ™°ã€‚")
            
        elif top_topic == "æƒ…æ„Ÿæ„›æƒ…":
            summary_parts.append("\nè¦ªå¯†é—œä¿‚æ˜¯**æœ€æ·±åˆ»çš„è‡ªæˆ‘èªè­˜é€”å¾‘**,ä¹Ÿæ˜¯æœ€å¤§çš„æˆé•·å¥‘æ©Ÿã€‚åœ¨é—œä¿‚ä¸­,æˆ‘å€‘æœƒçœ‹è¦‹è‡ªå·±çš„éœ€æ±‚ã€ææ‡¼ã€ä¾é™„æ¨¡å¼ã€ä»¥åŠæ„›èˆ‡è¢«æ„›çš„èƒ½åŠ›ã€‚")
            summary_parts.append("\nç„¡è«–ä½ è™•æ–¼å“ªå€‹éšæ®µ(å–®èº«ã€æ›–æ˜§ã€ç†±æˆ€ã€ç©©å®šæœŸã€è¡çªæœŸã€åˆ†é›¢),éƒ½å€¼å¾—æ€è€ƒ:")
            summary_parts.append("â€¢ **ä½ çš„ä¾é™„é¢¨æ ¼**: é—œä¿‚å¿ƒç†å­¸ç ”ç©¶ç™¼ç¾,**ç«¥å¹´èˆ‡ä¸»è¦ç…§é¡§è€…çš„äº’å‹•**å½¢æˆæˆ‘å€‘çš„ä¾é™„æ¨¡å¼ã€‚**å®‰å…¨å‹**èƒ½è¦ªè¿‘ä¹Ÿèƒ½ç¨ç«‹;**ç„¦æ…®å‹**æ¸´æœ›è¦ªå¯†å»æ€•è¢«æ‹‹æ£„;**è¿´é¿å‹**é‡è¦–ç¨ç«‹å»é›£ä»¥è¦ªå¯†ã€‚äº†è§£è‡ªå·±èˆ‡å°æ–¹çš„ä¾é™„é¢¨æ ¼,èƒ½è§£é‡‹å¾ˆå¤šé—œä¿‚å‹•åŠ›ã€‚")
            summary_parts.append("â€¢ **å®Œæ•´çš„è‡ªå·±**: å¥åº·çš„é—œä¿‚ä¸æ˜¯ã€Œä½ å®Œæ•´äº†æˆ‘ã€,è€Œæ˜¯ã€Œ**å…©å€‹å®Œæ•´çš„äººé¸æ“‡åŒè¡Œ**ã€ã€‚åœ¨é—œä¿‚ä¸­,ä½ æ˜¯å¦ä¿æŒè‡ªæˆ‘(èˆˆè¶£ã€æœ‹å‹ã€ç›®æ¨™)?é‚„æ˜¯éåº¦èåˆã€å¤±å»ç•Œç·š?")
            summary_parts.append("â€¢ **æºé€šèˆ‡ä¿®å¾©**: æ‰€æœ‰é—œä¿‚éƒ½æœƒæœ‰è¡çª,**é‡é»ä¸æ˜¯ä¸åµæ¶,è€Œæ˜¯å¦‚ä½•ä¿®å¾©**ã€‚èƒ½å¦åœ¨è¡çªå¾Œ:æ‰¿èªéŒ¯èª¤ã€è¡¨é”æ„Ÿå—ã€ç†è§£å°æ–¹ã€æ‰¾åˆ°è§£æ±ºæ–¹å¼?ä¿®å¾©èƒ½åŠ›æ±ºå®šé—œä¿‚å“è³ªã€‚")
            summary_parts.append("â€¢ **æ„›çš„èªè¨€**: Gary Chapman æå‡ºäº”ç¨®æ„›çš„èªè¨€:è‚¯å®šè¨€èªã€ç²¾å¿ƒæ™‚åˆ»ã€è´ˆé€ç¦®ç‰©ã€æœå‹™è¡Œå‹•ã€èº«é«”æ¥è§¸ã€‚**ä½ å¦‚ä½•è¡¨é”æ„›?ä½ å¦‚ä½•æ¥æ”¶æ„›?** ä¸åŒ¹é…æ™‚æœƒç”¢ç”Ÿã€Œæˆ‘æ˜æ˜å¾ˆæ„›ä½ ,ä½ å»æ„Ÿå—ä¸åˆ°ã€çš„å›°å¢ƒã€‚")
            summary_parts.append("\nå¦‚æœé—œä¿‚å¸¶ä¾†æŒçºŒçš„ç—›è‹¦(ä¸è¢«å°Šé‡ã€æ§åˆ¶ã€æƒ…ç·’å‹’ç´¢ã€æš´åŠ›),è«‹è¨˜å¾—:**ä½ å€¼å¾—è¢«å¥½å¥½å°å¾…**ã€‚é›¢é–‹ä¸å¥åº·çš„é—œä¿‚ä¸æ˜¯å¤±æ•—,è€Œæ˜¯æ„›è‡ªå·±çš„å‹‡æ°£ã€‚")
            
        elif top_topic == "å­¸æ¥­æˆé•·":
            summary_parts.append("\nå­¸ç¿’æ˜¯çµ‚èº«çš„æ—…ç¨‹,ä½†åœ¨å­¸æ ¡ç³»çµ±ä¸­,å®ƒå¸¸è¢«çª„åŒ–ç‚ºã€Œè€ƒè©¦ã€èˆ‡ã€Œæˆç¸¾ã€ã€‚ç•¶å­¸æ¥­æˆç‚ºä¸»è¦é—œæ³¨,å€¼å¾—é‡æ–°æ€è€ƒ:**å­¸ç¿’çš„æœ¬è³ªæ˜¯ä»€éº¼?**")
            summary_parts.append("\nå¿ƒç†å­¸å®¶ Carol Dweck æå‡ºã€Œ**æˆé•·å‹æ€ç¶­ vs. å›ºå®šå‹æ€ç¶­**ã€:å›ºå®šå‹èªç‚ºèƒ½åŠ›æ˜¯å¤©ç”Ÿçš„(ã€Œæˆ‘å°±æ˜¯ä¸æ“…é•·æ•¸å­¸ã€),æˆé•·å‹ç›¸ä¿¡èƒ½åŠ›å¯ä»¥åŸ¹é¤Š(ã€Œæˆ‘é‚„ä¸æ“…é•·,ä½†å¯ä»¥é€²æ­¥ã€)ã€‚é€™å€‹å·®ç•°æœƒ**æ·±åˆ»å½±éŸ¿å­¸ç¿’å‹•æ©Ÿèˆ‡è¡¨ç¾**ã€‚")
            summary_parts.append("â€¢ **åˆ»æ„ç·´ç¿’**: ä¸æ˜¯ã€ŒèŠ±å¾ˆå¤šæ™‚é–“ã€å°±æœƒé€²æ­¥,è€Œæ˜¯è¦**å°ˆæ³¨åœ¨ç¨å¾®è¶…å‡ºèƒ½åŠ›ç¯„åœçš„æŒ‘æˆ°**,ä¸¦ç«‹å³ç²å¾—åé¥‹ã€èª¿æ•´ç­–ç•¥ã€‚é€™æ˜¯é ‚å°–è¡¨ç¾è€…çš„å…±åŒç‰¹è³ªã€‚")
            summary_parts.append("â€¢ **å­¸ç¿’å‹•æ©Ÿ**: ä½ ç‚ºä»€éº¼å­¸ç¿’?æ˜¯**å…§åœ¨å‹•æ©Ÿ**(å¥½å¥‡ã€èˆˆè¶£ã€æˆå°±æ„Ÿ)é‚„æ˜¯**å¤–åœ¨å‹•æ©Ÿ**(åˆ†æ•¸ã€ä»–äººæœŸå¾…ã€é¿å…æ‡²ç½°)?ç ”ç©¶é¡¯ç¤º,å…§åœ¨å‹•æ©Ÿèƒ½å¸¶ä¾†æ›´æ·±å…¥çš„å­¸ç¿’èˆ‡æ›´æŒä¹…çš„èˆˆè¶£ã€‚å¦‚ä½•æ‰¾åˆ°å­¸ç¿’çš„æ„ç¾©,è€Œéåªæ˜¯å®Œæˆä»»å‹™?")
            summary_parts.append("â€¢ **éŒ¯èª¤èˆ‡å¤±æ•—**: ç¥ç¶“ç§‘å­¸ç ”ç©¶é¡¯ç¤º,**å¤§è…¦åœ¨çŠ¯éŒ¯æ™‚å­¸å¾—æœ€å¤š**ã€‚å°‡éŒ¯èª¤è¦–ç‚ºã€Œæˆé•·è­‰æ“šã€è€Œéã€Œèƒ½åŠ›ä¸è¶³ã€,ä½ æœƒæ›´é¡˜æ„æŒ‘æˆ°å›°é›£ã€å†’éšªå˜—è©¦ã€‚")
            summary_parts.append("â€¢ **å¾Œè¨­èªçŸ¥**: ä¸åªæ˜¯å­¸ç¿’,æ›´è¦ã€Œ**å­¸ç¿’å¦‚ä½•å­¸ç¿’**ã€ã€‚å®šæœŸåæ€:ä»€éº¼æ–¹æ³•å°æˆ‘æœ‰æ•ˆ?æˆ‘çš„å­¸ç¿’ç“¶é ¸åœ¨å“ª?å¦‚ä½•èª¿æ•´ç­–ç•¥?é€™ç¨®è‡ªæˆ‘è¦ºå¯Ÿèƒ½æå‡å­¸ç¿’æ•ˆç‡ 2-3 å€ã€‚")
            summary_parts.append("\nè¨˜ä½:**æˆç¸¾ä¸ä»£è¡¨ä½ çš„åƒ¹å€¼,ä¹Ÿä¸æ±ºå®šä½ çš„æœªä¾†**ã€‚å®ƒåªæ˜¯ç¾éšæ®µå­¸ç¿’æˆæœçš„ä¸€å€‹æŒ‡æ¨™ã€‚åŸ¹é¤ŠçœŸæ­£çš„èƒ½åŠ›(æ€è€ƒã€å‰µé€ ã€è§£æ±ºå•é¡Œã€èˆ‡äººå”ä½œ)æ¯”åˆ†æ•¸æ›´é‡è¦ã€‚")
            
        elif top_topic == "èº«å¿ƒå¥åº·":
            summary_parts.append("\nç•¶å¥åº·æˆç‚ºä¸»è¦é—œæ³¨,èº«é«”å¯èƒ½åœ¨å‘ä½ ç™¼å‡ºè¨Šè™Ÿ:**æˆ‘éœ€è¦è¢«ç…§é¡§**ã€**å£“åŠ›å¤ªå¤§äº†**ã€**ç”Ÿæ´»å¤±è¡¡äº†**ã€‚")
            summary_parts.append("\nç¾ä»£é†«å­¸è¶Šä¾†è¶Šèªè­˜åˆ°ã€Œ**å¿ƒèº«é†«å­¸(Psychosomatic Medicine)**ã€çš„é‡è¦æ€§:**èº«å¿ƒæ˜¯ä¸€é«”çš„**ã€‚å¿ƒç†å£“åŠ›æœƒè¡¨ç¾ç‚ºèº«é«”ç—‡ç‹€(é ­ç—›ã€èƒƒç—›ã€å¤±çœ ã€å…ç–«åŠ›ä¸‹é™),è€Œèº«é«”ä¸é©ä¹Ÿæœƒå½±éŸ¿å¿ƒç†ç‹€æ…‹(ç–²å‹å°è‡´æ†‚é¬±ã€ç–¼ç—›å°è‡´ç„¦æ…®)ã€‚")
            summary_parts.append("â€¢ **åŸºæœ¬çš„è‡ªæˆ‘ç…§é¡§**: é€™ä¸æ˜¯ã€Œæ‡‰è©²åšã€,è€Œæ˜¯**ä¸å¯å”å•†çš„å¿…éœ€å“**:")
            summary_parts.append("  - **ç¡çœ **: æˆäººéœ€è¦ 7-9 å°æ™‚ã€‚ç¡çœ ä¸è¶³æœƒå°è‡´æƒ…ç·’å¤±èª¿ã€èªçŸ¥ä¸‹é™ã€å…ç–«åŠ›é™ä½ã€‚æŠŠç¡çœ ç•¶ä½œã€Œ**å……é›»**ã€,è€Œéã€Œæµªè²»æ™‚é–“ã€ã€‚")
            summary_parts.append("  - **é‹å‹•**: ä¸éœ€è¦æ¿€çƒˆé‹å‹•,**æ¯å¤© 20-30 åˆ†é˜ä¸­ç­‰å¼·åº¦æ´»å‹•**(å¿«èµ°ã€æ¸¸æ³³ã€è·³èˆ)å°±èƒ½é¡¯è‘—æ”¹å–„æƒ…ç·’èˆ‡å¥åº·ã€‚é‹å‹•æ˜¯å¤©ç„¶çš„æŠ—æ†‚é¬±è—¥ã€‚")
            summary_parts.append("  - **é£²é£Ÿ**: ä½ åƒé€²å»çš„é£Ÿç‰©**ç›´æ¥å½±éŸ¿å¤§è…¦åŠŸèƒ½èˆ‡æƒ…ç·’**ã€‚æ¸›å°‘ç²¾ç·»ç³–ã€å¢åŠ è”¬æœèˆ‡ Omega-3,èƒ½æ”¹å–„å¿ƒç†å¥åº·ã€‚")
            summary_parts.append("  - **ç¤¾äº¤é€£çµ**: å­¤ç«‹æœƒå¢åŠ æ­»äº¡ç‡ 30%,ç›¸ç•¶æ–¼æ¯å¤©æŠ½ 15 æ ¹è¸ã€‚å®šæœŸèˆ‡äººé€£çµ(é¢å°é¢,è€Œéåªæ˜¯ç·šä¸Š)æ˜¯å¥åº·çš„é—œéµã€‚")
            summary_parts.append("â€¢ **å£“åŠ›èˆ‡ç–¾ç—…**: é•·æœŸå£“åŠ›æœƒå°è‡´**æ…¢æ€§ç™¼ç‚**,é€™æ˜¯è¨±å¤šç–¾ç—…çš„æ ¹æº(å¿ƒè¡€ç®¡ç–¾ç—…ã€è‡ªé«”å…ç–«ç–¾ç—…ã€ç™Œç—‡)ã€‚å­¸ç¿’å£“åŠ›ç®¡ç†ä¸æ˜¯å¥¢ä¾ˆ,è€Œæ˜¯**å¥åº·çš„å¿…è¦æŠ•è³‡**ã€‚")
            summary_parts.append("â€¢ **èº«é«”è¨Šè™Ÿ**: å­¸ç¿’**å‚¾è½èº«é«”**:å“ªè£¡ç·Šç¹ƒ?å“ªè£¡ç–¼ç—›?å“ªè£¡æœ‰å£“åŠ›?èº«é«”æ¯”é ­è…¦æ›´èª å¯¦,å®ƒæœƒå‘Šè¨´ä½ çœŸå¯¦çš„ç‹€æ…‹ã€‚")
            summary_parts.append("\nå¦‚æœèº«é«”ç—‡ç‹€æŒçºŒ,è«‹å°‹æ±‚é†«ç™‚å”åŠ©ã€‚åŒæ™‚ä¹Ÿè€ƒæ…®:**é€™äº›ç—‡ç‹€èƒŒå¾Œ,æœ‰ä»€éº¼å¿ƒç†æˆ–ç”Ÿæ´»å£“åŠ›å› ç´ ?** æœ‰æ™‚å€™,æ²»ç™‚ç—‡ç‹€çš„åŒæ™‚,ä¹Ÿéœ€è¦è™•ç†æ ¹æºã€‚")
    
    # æƒ…ç·’è¶¨å‹¢çš„æ·±åº¦åˆ†æ
    if trend_info and trend_info.get("trend") != "insufficient_data":
        trend = trend_info.get("trend")
        description = trend_info.get("description", "")
        
        summary_parts.append(f"\nğŸ“ˆ **æƒ…ç·’è»Œè·¡è§€å¯Ÿ**")
        summary_parts.append(f"{description}")
        
        if trend == "concerning":
            summary_parts.append("\nç•¶è² é¢æƒ…ç·’æŒçºŒä½”ä¸»å°,é€™æ˜¯**èº«å¿ƒéœ€è¦ç…§é¡§çš„æ˜ç¢ºä¿¡è™Ÿ**ã€‚é€™ä¸ä»£è¡¨ä½ ã€Œä¸å¤ å …å¼·ã€æˆ–ã€Œæƒ³å¤ªå¤šã€,è€Œæ˜¯ä½ çš„ç³»çµ±åœ¨èªª:**ç¾åœ¨çš„ç‹€æ…‹ç„¡æ³•æŒçºŒ**ã€‚")
            summary_parts.append("\n**å»ºè­°è¡Œå‹•**:")
            summary_parts.append("â€¢ **å°‹æ±‚å°ˆæ¥­æ”¯æŒ**: å¿ƒç†è«®å•†ä¸æ˜¯ã€Œå´©æ½°äº†æ‰å»ã€,è€Œæ˜¯**é é˜²èˆ‡è‡ªæˆ‘æŠ•è³‡**ã€‚å°±åƒèº«é«”ä¸èˆ’æœçœ‹é†«ç”Ÿ,å¿ƒç†ä¸é©ä¹Ÿè©²å°‹æ±‚å°ˆæ¥­ã€‚")
            summary_parts.append("â€¢ **å»ºç«‹æ”¯æŒç³»çµ±**: æ‰¾ 1-3 ä½å¯ä»¥çœŸå¯¦è¡¨é”æƒ…ç·’çš„äºº(æœ‹å‹ã€å®¶äººã€æ”¯æŒåœ˜é«”)ã€‚**èªªå‡ºä¾†æœ¬èº«å°±æ˜¯ç™‚ç™’**ã€‚")
            summary_parts.append("â€¢ **é™ä½è¦æ±‚**: æš«æ™‚é™ä½å°è‡ªå·±çš„æœŸå¾…,**åªåšå¿…è¦çš„äº‹**ã€‚çµ¦è‡ªå·±å¾©åŸçš„æ™‚é–“èˆ‡ç©ºé–“ã€‚")
            summary_parts.append("â€¢ **å±æ©Ÿè³‡æº**: å¦‚æœæœ‰è‡ªå‚·æˆ–å‚·äººå¿µé ­,è«‹ç«‹å³è¯ç¹«**ç”Ÿå‘½ç·š 1995**ã€**å¼µè€å¸« 1980**ã€**å®‰å¿ƒå°ˆç·š 1925**,æˆ–å‰å¾€æ€¥è¨ºã€‚ä½ çš„ç”Ÿå‘½å¾ˆé‡è¦ã€‚")
            
        elif trend == "fluctuating":
            summary_parts.append("\næƒ…ç·’çš„èµ·ä¼æ˜¯æ­£å¸¸çš„,ä½†å¦‚æœ**æ³¢å‹•éå¤§**å½±éŸ¿ç”Ÿæ´»(ä»Šå¤©å¾ˆhighæ˜å¤©å¾ˆlowã€æƒ…ç·’çªç„¶è½‰è®Šã€é›£ä»¥é æ¸¬è‡ªå·±çš„ç‹€æ…‹),å€¼å¾—é—œæ³¨ã€‚")
            summary_parts.append("\n**å¯èƒ½åŸå› **:")
            summary_parts.append("â€¢ **å¤–åœ¨å£“åŠ›æº**: ç”Ÿæ´»ä¸­æ˜¯å¦æœ‰ä¸ç©©å®šå› ç´ (å·¥ä½œè®Šå‹•ã€é—œä¿‚è¡çªã€ç¶“æ¿Ÿå£“åŠ›)?")
            summary_parts.append("â€¢ **ç”Ÿç†å› ç´ **: ç¡çœ ä¸è¶³ã€è·çˆ¾è’™è®ŠåŒ–ã€è¡€ç³–æ³¢å‹•éƒ½æœƒå½±éŸ¿æƒ…ç·’ç©©å®šã€‚")
            summary_parts.append("â€¢ **æƒ…ç·’èª¿ç¯€èƒ½åŠ›**: æ˜¯å¦ç¼ºä¹æœ‰æ•ˆçš„æƒ…ç·’ç®¡ç†ç­–ç•¥?")
            summary_parts.append("\n**ç©©å®šç­–ç•¥**:")
            summary_parts.append("â€¢ **è¦å¾‹ä½œæ¯**: å›ºå®šçš„ç¡çœ ã€é£²é£Ÿã€é‹å‹•æ™‚é–“èƒ½**ç©©å®šç”Ÿç†èˆ‡å¿ƒç†ç¯€å¥**ã€‚")
            summary_parts.append("â€¢ **æƒ…ç·’æ—¥èªŒ**: è¨˜éŒ„æƒ…ç·’è®ŠåŒ–èˆ‡è§¸ç™¼å› ç´ ,æ‰¾å‡º**æ¨¡å¼èˆ‡é€±æœŸ**(æ˜¯å¦èˆ‡æœˆç¶“é€±æœŸã€å·¥ä½œé€±æœŸã€ç‰¹å®šäººäº‹ç‰©æœ‰é—œ)ã€‚")
            summary_parts.append("â€¢ **å­¸ç¿’æŠ€å·§**: æ­£å¿µã€å‘¼å¸ç·´ç¿’ã€æ¼¸é€²å¼è‚Œè‚‰æ”¾é¬†,éƒ½èƒ½å¹«åŠ©ä½ åœ¨æƒ…ç·’é«˜å³°æ™‚**æ‰¾åˆ°å…§åœ¨ç©©å®šéŒ¨**ã€‚")
            
        else:  # stable
            summary_parts.append("\næƒ…ç·’çš„ç›¸å°ç©©å®šé¡¯ç¤ºä½ å…·å‚™è‰¯å¥½çš„**å¿ƒç†å¹³è¡¡èƒ½åŠ›**ã€‚é€™ä¸æ˜¯èªªä½ ä¸æœƒæœ‰æƒ…ç·’,è€Œæ˜¯ä½ èƒ½åœ¨èµ·ä¼ä¸­ç¶­æŒä¸€å®šçš„ç©©å®šæ€§ã€‚")
            summary_parts.append("\n**ç¶­æŒç©©å®šçš„ç§˜è¨£**:")
            summary_parts.append("â€¢ ç¹¼çºŒä½ æ­£åœ¨åšçš„äº‹(è¦å¾‹ä½œæ¯ã€æ”¯æŒç³»çµ±ã€å£“åŠ›ç®¡ç†)")
            summary_parts.append("â€¢ å®šæœŸã€Œ**å¿ƒç†å¥æª¢**ã€:æ¯é€±èŠ± 10 åˆ†é˜åæ€:æˆ‘çš„ç‹€æ…‹å¦‚ä½•?æœ‰ä»€éº¼éœ€è¦èª¿æ•´?")
            summary_parts.append("â€¢ ä¸è¦ç­‰åˆ°å´©æ½°æ‰è™•ç†,**é é˜²å‹æ–¼æ²»ç™‚**")
    
    # æ•´åˆæ€§çµèª - æº«æš–ä¸”è³¦èƒ½
    summary_parts.append(f"\nğŸ’ **å¯«åœ¨æœ€å¾Œ**")
    summary_parts.append(f"é€™ **{message_count} æ¬¡å°è©±**ä¸åªæ˜¯æ–‡å­—ç´€éŒ„,æ›´æ˜¯ä½ **è‡ªæˆ‘ç†è§£çš„æ—…ç¨‹**ã€‚æ¯ä¸€æ¬¡ä½ é¡˜æ„èªªå‡ºå…§å¿ƒæ„Ÿå—,éƒ½æ˜¯å‹‡æ°£çš„å±•ç¾ã€‚")
    summary_parts.append("\nå¿ƒç†å­¸å®¶ Carl Rogers èªª:ã€Œ**ç•¶æˆ‘è¢«ç†è§£,æˆ‘å°±èƒ½æˆé•·**ã€‚ã€åœ¨é€™è£¡,ä½ ä¸éœ€è¦å½è£ã€ä¸éœ€è¦å®Œç¾,åªéœ€è¦çœŸå¯¦ã€‚")
    summary_parts.append("\n**è«‹è¨˜ä½å¹¾ä»¶äº‹**:")
    summary_parts.append("â€¢ **æƒ…ç·’æ²’æœ‰å°éŒ¯**: æ‰€æœ‰æƒ…ç·’éƒ½æ˜¯æœ‰æ•ˆçš„è¨Šè™Ÿ,åŒ…æ‹¬é‚£äº›ã€Œä¸æ‡‰è©²æœ‰ã€çš„æƒ…ç·’(æ†¤æ€’ã€å«‰å¦’ã€æ‚²å‚·)ã€‚")
    summary_parts.append("â€¢ **æ”¹è®Šéœ€è¦æ™‚é–“**: å¿ƒç†æˆé•·ä¸æ˜¯ç·šæ€§çš„,æœƒæœ‰é€²æ­¥ã€åœæ»¯ã€ç”šè‡³å€’é€€ã€‚**é€™éƒ½æ˜¯éç¨‹çš„ä¸€éƒ¨åˆ†**ã€‚")
    summary_parts.append("â€¢ **ä½ ä¸å­¤å–®**: ä½ ç¶“æ­·çš„å›°æ“¾,å¾ˆå¤šäººä¹Ÿåœ¨ç¶“æ­·ã€‚å°‹æ±‚å¹«åŠ©ä¸æ˜¯è»Ÿå¼±,è€Œæ˜¯æ™ºæ…§ã€‚")
    summary_parts.append("â€¢ **ä½ å€¼å¾—è¢«å¥½å¥½å°å¾…**: åŒ…æ‹¬è¢«è‡ªå·±å¥½å¥½å°å¾…ã€‚å°è‡ªå·±æº«æŸ”ä¸€é»,å°±åƒä½ å°å¾…æ‘¯å‹é‚£æ¨£ã€‚")
    summary_parts.append("\næŒçºŒé€™æ®µå°è©±,æŒçºŒè‡ªæˆ‘æ¢ç´¢ã€‚**ä½ æ­£åœ¨æˆç‚ºæ›´ç†è§£è‡ªå·±ã€æ›´å®Œæ•´çš„è‡ªå·±**ã€‚é€™æ¢è·¯ä¸ç¸½æ˜¯å®¹æ˜“,ä½†ä½ èµ°å¾—å¾ˆå¥½ã€‚æˆ‘æœƒä¸€ç›´åœ¨é€™è£¡,é™ªä½ ä¸€èµ·å‰è¡Œã€‚")
    
    return "\n\n".join(summary_parts)

# ============================================================================
# ä¸»è¦åˆ†æå‡½æ•¸
# ============================================================================

def analyze_chat_messages(messages: List[Dict[str, Any]]) -> Dict[str, Any]:
    """
    å°ˆæ¥­ç‰ˆèŠå¤©è¨Šæ¯åˆ†æ
    
    Args:
        messages: èŠå¤©è¨Šæ¯åˆ—è¡¨
    
    Returns:
        å®Œæ•´çš„åˆ†æå ±å‘Š
    """
    # åªåˆ†æä½¿ç”¨è€…è¨Šæ¯
    user_messages = [m for m in messages if m.get("role") == "user"]
    
    if len(user_messages) < 30:
        return {
            "ok": False,
            "has_sufficient_data": False,
            "message_count": len(user_messages),
            "required_count": 30,
            "message": f"ç›®å‰å°è©±æ¬¡æ•¸ç‚º {len(user_messages)} æ¬¡ï¼Œè‡³å°‘éœ€è¦ 30 æ¬¡å°è©±æ‰èƒ½é€²è¡Œå®Œæ•´åˆ†æ"
        }
    
    # åˆå§‹åŒ–çµ±è¨ˆå®¹å™¨
    emotion_frequency = Counter()
    emotion_intensity_sum = defaultdict(float)
    emotion_count = defaultdict(int)
    topic_scores = Counter()
    timeline_data = []
    
    # è¨ˆç®—æ¯å‰‡è¨Šæ¯è·ä»Šå¤©æ•¸
    now = datetime.now()
    
    for msg in user_messages:
        text = msg.get("content", "")
        created_at_str = msg.get("created_at")
        
        # è¨ˆç®—å¤©æ•¸å·®
        days_ago = 0
        if created_at_str:
            try:
                msg_date = datetime.fromisoformat(created_at_str.replace('Z', '+00:00'))
                days_ago = (now - msg_date).days
            except:
                days_ago = 0
        
        # åµæ¸¬æƒ…ç·’ï¼ˆé€²éšç‰ˆï¼‰
        emotions = detect_emotions_advanced(text, days_ago)
        
        if emotions:
            # æ‰¾å‡ºä¸»è¦æƒ…ç·’
            dominant_emotion = max(emotions.items(), key=lambda x: x[1])[0]
            dominant_score = emotions[dominant_emotion]
            
            # çµ±è¨ˆ
            emotion_frequency[dominant_emotion] += 1
            
            for emotion, score in emotions.items():
                emotion_intensity_sum[emotion] += score
                emotion_count[emotion] += 1
            
            # æ™‚é–“åºåˆ—è¨˜éŒ„
            timeline_data.append({
                "date": created_at_str,
                "dominant_emotion": dominant_emotion,
                "score": dominant_score,
                "all_emotions": emotions
            })
        
        # åµæ¸¬è­°é¡Œ
        topics = detect_topics_advanced(text)
        for topic, score in topics.items():
            topic_scores[topic] += score
    
    # è¨ˆç®—å¹³å‡æƒ…ç·’å¼·åº¦
    emotion_intensity_avg = {
        emotion: emotion_intensity_sum[emotion] / emotion_count[emotion]
        for emotion in emotion_count
    }
    
    # åˆ†æè¶¨å‹¢
    trend_info = analyze_emotion_trends(timeline_data)
    
    # ç”Ÿæˆå°ˆæ¥­æ‘˜è¦
    summary = generate_professional_summary(
        dict(emotion_frequency),
        emotion_intensity_avg,
        dict(topic_scores),
        len(user_messages),
        trend_info
    )
    
# âœ… ä¿®æ­£ï¼šæ­£ç¢ºè™•ç† Counter.most_common() è¿”å›çš„ list
    topic_radar_data = {}
    for topic, score in topic_scores.most_common(6):
        topic_radar_data[topic] = round(score * 20, 1)

    # æº–å‚™åœ–è¡¨æ•¸æ“š
    return {
        "ok": True,
        "has_sufficient_data": True,
        "message_count": len(user_messages),
        "emotion_frequency": dict(emotion_frequency.most_common(7)),
        "emotion_intensity": {k: round(v * 100, 1) for k, v in emotion_intensity_avg.items()},
        "topic_radar": topic_radar_data,
        "timeline_data": timeline_data[-30:],  # åªè¿”å›æœ€è¿‘30ç­†
        "trend_analysis": trend_info,
        "summary": summary,
        "analysis_meta": {
            "analyzed_at": datetime.now().isoformat(),
            "period_start": user_messages[0].get("created_at") if user_messages else None,
            "period_end": user_messages[-1].get("created_at") if user_messages else None,
            "total_days": days_ago if user_messages else 0
        },
        "emotion_colors": {k: v["color"] for k, v in EMOTION_KEYWORDS.items()},
        "topic_colors": {k: v["color"] for k, v in TOPIC_KEYWORDS.items()}
    }